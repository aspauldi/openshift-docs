// Module included in the following assemblies:
//
// * virt/live_migration/virt-about-mtv-providers.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-creating-long-lived-account-and-token_{context}"]
= Creating the long-lived service account and token to use with MTV providers

{VirtProductName} uses role-based access control (RBAC) to define permissions for human users and service accounts. The permissions defined for service accounts control the actions that {VirtProductName} components can perform.

You can also use RBAC roles to manage user access to virtualization features. For example, an administrator can create an RBAC role that provides the permissions required to launch a virtual machine. The administrator can then restrict access by binding the role to specific users.

You must create a long-lived service account and a cluster role binding. The cluster role binding is required to map the service account to the cluster role.

.Procedure

. Create the cluster role as shown in the following example:
+
[source,yaml]
----
+apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: live-migration-role
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
      - namespaces
      - configmaps
      - persistentvolumes
      - persistentvolumeclaims
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - k8s.cni.cncf.io
    resources:
      - network-attachment-definitions
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - storage.k8s.io
    resources:
      - storageclasses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - kubevirt.io
    resources:
      - virtualmachines
      - virtualmachines/finalizers
      - virtualmachineinstancemigrations
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - kubevirt.io
    resources:
      - kubevirts
      - virtualmachineinstances
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - cdi.kubevirt.io
    resources:
      - datavolumes
      - datavolumes/finalizers
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
  - apiGroups:
      - instancetype.kubevirt.io
    resources:
      - virtualmachineclusterpreferences
      - virtualmachineclusterinstancetypes
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - instancetype.kubevirt.io
    resources:
      - virtualmachinepreferences
      - virtualmachineinstancetypes
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
----
. Run this command to create the service account:
+
[source,terminal]
----
$ oc create serviceaccount <service_account_name> -n <namespace_bound_to_service_account>
----

. Run this command to use a cluster role binding that links the service account to the cluster role:
+
[source,terminal]
----
$ oc create clusterrolebinding <service_account_name> --clusterrole=<cluster_role_name>               --serviceaccount=<namespace_bound_to_service_account>:<service_account_name>
----

. Create a secret to hold the token, as shown in the following example:
+
[source,yaml]
----
cat <<EOF | oc apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: <name of secret>
  namespace: <namespace_you_want_sa>
  annotations:
    kubernetes.io/service-account.name: <sa_name>
type: kubernetes.io/service-account-token
EOF
----

. After the secret is populated (typically within a few seconds), run the following command:
+
[source,terminal]
----
$ TOKEN_BASE64=$(oc get secret "<name_of_secret>" -n "<namespace_bound_to_service_account>" -o jsonpath='{.data.token}')
  TOKEN=$(echo "$TOKEN_BASE64" | base64 --decode)
  echo "$TOKEN"
----

. Copy the printed token, and paste it into the form.

